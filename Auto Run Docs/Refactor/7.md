# Refactor Task 7: `src/main/web-server.ts`

## Summary

The web-server.ts file (866 lines) is the main Fastify server for web/mobile interface access. The code has been **well-refactored** with route handlers, message handlers, and broadcast services extracted into the `src/main/web-server/` subdirectory. However, there are significant **type definition duplications** across the web-server module hierarchy, several **weak type patterns**, and some **minor code smells** that should be addressed.

**Key Findings:**
- 6 type definitions duplicated across 3-4 locations within the web-server module
- 4 instances of weak `any`-adjacent patterns (`unknown` in index signatures)
- 14 callback setter methods following repetitive patterns - could benefit from consolidation
- Re-export of `Theme` type for "backwards compatibility" may be unnecessary
- `readFileSync` blocking calls in static routes

## Dead Code

- **`re-export for backwards compatibility` (line 183-184):** `export type { Theme } from '../shared/theme-types';` - This re-export is labeled as being for backwards compatibility, but should be verified if any consumer actually imports Theme from web-server.ts rather than directly from shared/theme-types.

- **Unused rate limit config field:** The `updateRateLimitConfig` method in `apiRoutes.ts:171-173` is defined but never called from web-server.ts or anywhere else. The rate limit config is only set during construction.

- **`webAssetsPath` null fallback comment (line 232):** Comment indicates `webAssetsPath` might not exist until built, but code handles this gracefully - not dead code, but comment is stale since the path resolution is now robust.

## Deprecated Patterns

- **Synchronous file I/O in request handlers (`staticRoutes.ts:74, 128, 140`):**
  - `readFileSync(indexPath, 'utf-8')` in `serveIndexHtml`
  - `readFileSync(manifestPath, 'utf-8')` for manifest.json
  - `readFileSync(swPath, 'utf-8')` for sw.js

  While these are fast for small files, synchronous reads can block the event loop under high load. Modern Fastify best practice is to use `reply.sendFile()` with `@fastify/static` or `fs.readFile` async.

- **Manual HTML injection (staticRoutes.ts:77-91):**
  The string replacement pattern for rewriting asset paths (`html.replace(/\.\/assets\//g, ...)`) is fragile. A proper build-time solution or Fastify plugin would be more robust.

- **Inline logger configuration (line 261-263):**
  ```typescript
  logger: {
    level: 'info',
  },
  ```
  Hardcoded log level should be configurable via environment or settings.

## Duplication

### Type Definition Duplication (High Severity)

The following types are defined in **multiple locations** within the web-server module:

| Type | Locations | Notes |
|------|-----------|-------|
| `SessionUsageStats` | web-server.ts:73, apiRoutes.ts:26 | Identical definitions |
| `LastResponsePreview` | web-server.ts:83, apiRoutes.ts:38 | Identical definitions |
| `AITabData` | web-server.ts:91, apiRoutes.ts:48, broadcastService.ts:52, web/hooks/useWebSocket.ts | 4 locations! |
| `LiveSessionInfo` | web-server.ts:33, apiRoutes.ts:109, wsRoute.ts:30, messageHandlers.ts:63 | 4 locations with slight variations |
| `CustomAICommand` | web-server.ts:190, wsRoute.ts:39, broadcastService.ts:42 | 3 locations |
| `SessionDetail` | web-server.ts:124, apiRoutes.ts:85 | Identical definitions |

**Recommendation:** Create a single `src/main/web-server/types.ts` file as the canonical source for all shared types. Re-export from index files.

### Callback Setter Pattern Duplication

Lines 386-498 contain 14 callback setter methods that all follow the exact same pattern:
```typescript
setXXXCallback(callback: XXXCallback) {
  this.xxxCallback = callback;
}
```

This could be consolidated using:
1. A single `setCallbacks(callbacks: WebServerCallbacks)` method
2. Or a generic callback registration pattern

### Session Enrichment Logic Duplication

The pattern of enriching sessions with live info is repeated in:
- `apiRoutes.ts:193-200` (in sessions endpoint)
- `apiRoutes.ts:240-246` (in session detail endpoint)
- `wsRoute.ts:134-142` (in WebSocket initial sync)
- `messageHandlers.ts:386-394` (in get_sessions handler)

```typescript
const sessionsWithLiveInfo = sessions.map(s => {
  const liveInfo = this.callbacks.getLiveSessionInfo?.(s.id);
  return {
    ...s,
    agentSessionId: liveInfo?.agentSessionId || s.agentSessionId,
    liveEnabledAt: liveInfo?.enabledAt,
    isLive: this.callbacks.isSessionLive?.(s.id) || false,
  };
});
```

**Recommendation:** Extract to a shared utility function: `enrichSessionsWithLiveInfo(sessions, getLiveInfo, isLive)`

## Code Smells

### 1. Long Callback List (Lines 218-232)
The WebServer class has **14 private callback fields**, making the class difficult to maintain:
```typescript
private getSessionsCallback: GetSessionsCallback | null = null;
private getSessionDetailCallback: GetSessionDetailCallback | null = null;
private getThemeCallback: GetThemeCallback | null = null;
// ... 11 more
```

**Recommendation:** Group callbacks into a single `WebServerCallbacks` interface and use a single `callbacks` field.

### 2. Nullable Callback Checks
Throughout the code, callbacks are checked with `?.` operator repeatedly:
```typescript
this.getSessionsCallback?.() ?? []
this.getSessionDetailCallback?.(sessionId, tabId) ?? null
this.executeCommandCallback?.(sessionId, command, inputMode)
```

This leads to defensive programming patterns everywhere. Consider requiring callbacks to be set before `start()` is called.

### 3. Magic Redirect URL (staticRoutes.ts:26)
```typescript
const REDIRECT_URL = 'https://runmaestro.ai';
```
This hardcoded URL should be configurable or at least defined as a constant in a central location.

### 4. Mixed Concerns in Constructor
The constructor (lines 257-286) handles:
- Port configuration
- Fastify instance creation
- Security token generation
- Web assets path resolution
- Service initialization
- Route handler initialization

This could be split into separate initialization methods for better testability.

### 5. Excessive Logging with Redundant Context
Several log statements include redundant context:
```typescript
logger.info('[WebServer] setSwitchModeCallback called', LOG_CONTEXT);
```
The `LOG_CONTEXT` already specifies 'WebServer', so the `[WebServer]` prefix is redundant.

## Type Safety Issues

### 1. Weak Index Signature Types (Multiple Locations)
- `messageHandlers.ts:38`: `[key: string]: unknown;` in `WebClientMessage`
- `messageHandlers.ts:89`: `[key: string]: unknown;` in session data return type
- `wsRoute.ts:57`: `[key: string]: unknown;` in `WsSessionData`

These open index signatures allow arbitrary additional properties, weakening type safety.

### 2. Type Assertions Without Validation
- `messageHandlers.ts:195-198`:
  ```typescript
  const sessionId = message.sessionId as string;
  const command = message.command as string;
  const clientInputMode = message.inputMode as 'ai' | 'terminal' | undefined;
  ```
  These assertions happen before validation, which could lead to runtime errors if the client sends malformed data.

### 3. Partial Callbacks Interface
- `messageHandlers.ts:102`: `private callbacks: Partial<MessageHandlerCallbacks> = {};`
- `wsRoute.ts:84`: `private callbacks: Partial<WsRouteCallbacks> = {};`
- `apiRoutes.ts:152`: `private callbacks: Partial<ApiRouteCallbacks> = {};`

Using `Partial<>` means any callback could be undefined, requiring null checks everywhere. Consider making callbacks required.

### 4. Non-Null Assertions in Callbacks
- `messageHandlers.ts:387-392`:
  ```typescript
  const liveInfo = this.callbacks.getLiveSessionInfo!(s.id);
  // ...
  isLive: this.callbacks.isSessionLive!(s.id),
  ```
  Non-null assertions (`!`) are used inside a conditional block that already checked `this.callbacks.getSessions`, but the other callbacks aren't guaranteed to exist.

### 5. Error Handler Type
- `apiRoutes.ts:366, 405`: `error: any` in catch blocks
  Should use `error: unknown` and proper type narrowing.

## Recommended Refactoring

1. **[High] Consolidate Type Definitions**
   Create `src/main/web-server/types.ts` as the single source of truth for all web-server types. Estimated effort: 2-3 hours.

2. **[High] Extract Session Enrichment Utility**
   Create `enrichSessionsWithLiveInfo` helper function to eliminate duplication. Estimated effort: 30 minutes.

3. **[Medium] Consolidate Callback Setters**
   Replace 14 individual callback setters with a single `setCallbacks(callbacks: WebServerCallbacks)` method. Estimated effort: 1-2 hours.

4. **[Medium] Make Callbacks Required**
   Remove `Partial<>` from callback interfaces and require all callbacks to be set before `start()`. Add runtime validation. Estimated effort: 1 hour.

5. **[Medium] Replace Synchronous File Reads**
   Use async file operations or Fastify's built-in static file serving with transformation hooks. Estimated effort: 1-2 hours.

6. **[Low] Fix Error Handler Types**
   Replace `error: any` with `error: unknown` and proper type guards. Estimated effort: 30 minutes.

7. **[Low] Remove Redundant Log Prefixes**
   Clean up logging statements that duplicate the LOG_CONTEXT. Estimated effort: 15 minutes.

## Estimated Impact

**Risk Level: Low-Medium**

The web-server module is already well-structured with good separation of concerns. Most refactoring is type consolidation and code deduplication, which are relatively safe changes.

**Testing Considerations:**
- Existing integration tests in `src/__tests__/e2e/WebServerSync.e2e.test.ts` and `src/__tests__/integration/RemoteControlSync.test.ts` cover core functionality
- Unit tests exist for broadcast service and message handlers
- Type changes should be verified with TypeScript compilation
- Async file reads should be tested for performance under load
