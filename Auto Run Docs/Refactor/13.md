# Refactor Task 13: src/main/ipc/handlers/agentSessions.ts

## Summary
The file is 795 lines and serves as the generic IPC handler layer for agent session management. It is well-structured with consistent handler patterns and proper use of the `withIpcErrorLogging` wrapper. However, there are significant issues with session discovery logic duplication, type duplication across renderer/main, cost calculation repetition, and empty catch blocks that silently swallow errors.

## Dead Code
- None found - all handlers (`list`, `listPaginated`, `read`, `search`, `getPath`, `deleteMessagePair`, `hasStorage`, `getAvailableStorages`, `getAllNamedSessions`, `getGlobalStats`) are exposed via preload.ts and actively used in renderer components.

## Deprecated Patterns
- None found - the file uses modern IPC patterns with `ipcMain.handle` and async/await throughout.
- Note: This file is the **preferred** API - the deprecated patterns are in the Claude-specific handlers that this replaces.

## Duplication

### 1. Session Discovery Logic (High Impact)
**File: agentSessions.ts:202-315**

`discoverClaudeSessionFiles()` (lines 202-242) and `discoverCodexSessionFiles()` (lines 248-315) duplicate session enumeration logic that already exists in:
- `src/main/storage/claude-session-storage.ts:270-323` - `listSessions()` and `listSessionsPaginated()`
- `src/main/storage/codex-session-storage.ts:302-438` - similar session discovery

Both sets of functions:
- Iterate through `~/.claude/projects/` or `~/.codex/sessions/` directories
- Filter for `.jsonl` files
- Handle file stats and skip 0-byte files

Recommendation: Refactor storage classes to expose a `discoverSessionFiles()` method and use it from `getGlobalStats`.

### 2. Cost Calculation (High Impact)
**File: agentSessions.ts:92-103**

`calculateClaudeCost()` function duplicates logic found in:
- `src/main/storage/claude-session-storage.ts:80-85`
- `src/main/ipc/handlers/claude.ts:240-244, 436-440, 548-552, 766-770` (4 instances!)

The same 4-line calculation pattern appears **6+ times** across the codebase.

Recommendation: Extract to `src/main/utils/costCalculation.ts` or add to `constants.ts`.

### 3. GlobalAgentStats Type (Medium Impact)
**File: agentSessions.ts:51-73**

The `GlobalAgentStats` interface is duplicated in:
- `src/renderer/components/AboutModal.tsx:10-31`
- `src/__tests__/renderer/components/AboutModal.test.tsx:88` (as `ClaudeGlobalStats`)

Recommendation: Export from a shared types file.

### 4. Session Parsing Logic (Medium Impact)
**File: agentSessions.ts:117-196**

`parseClaudeSessionContent()` and `parseCodexSessionContent()` use regex-based token extraction that partially overlaps with parsing logic in the storage classes and parsers.

## Code Smells

### 1. Empty Catch Blocks (Medium Impact)
**Lines: 182, 209, 232, 236, 255, 297, 301, 305, 309**

Nine `catch { }` blocks silently swallow errors during session discovery. While this may be intentional (skip inaccessible files), it makes debugging difficult.

```typescript
// Example at line 232
} catch {
  // Skip files we can't stat
}
```

Recommendation: Log at debug level or add explicit comment explaining why errors are ignored.

### 2. Magic Number for Progress Updates
**Lines: 745, 768**

```typescript
if (processedCount % 10 === 0 || processedCount === claudeToProcess.length) {
```

The batch size `10` should be a named constant like `STATS_PROGRESS_BATCH_SIZE`.

### 3. getGlobalStats Handler Complexity (Medium Impact)
**Lines: 591-793 (202 lines)**

The `getGlobalStats` handler is 200+ lines with:
- Inline helper functions (`buildResultFromCache`, `sendUpdate`)
- File discovery for multiple providers
- Cache management
- Progressive updates

Recommendation: Extract to a dedicated `GlobalStatsCalculator` class.

### 4. Deep Nesting in discoverCodexSessionFiles
**Lines: 259-315 (4 levels deep)**

The Codex session discovery iterates YYYY/MM/DD directories with 4 nested try-catch blocks, making it hard to follow.

## Type Safety Issues
- **None found** - The file has excellent type safety:
  - No `any` types in function signatures
  - Proper use of imported types from `agent-session-storage`
  - Return types explicitly annotated on all handlers
  - Proper type imports (`CachedSessionStats`, `GlobalStatsCache`, etc.)

## Recommended Refactoring

1. **High Priority - Extract Cost Calculation Utility**
   Create `src/main/utils/costCalculation.ts` with `calculateClaudeCost()` function and use it everywhere.
   Estimated effort: 30 minutes

2. **High Priority - Deduplicate Session Discovery**
   Add `discoverAllSessions()` method to storage interface and use it from `getGlobalStats` instead of reimplementing.
   Estimated effort: 2 hours

3. **Medium Priority - Export GlobalAgentStats Type**
   Move to `src/shared/types.ts` or create `src/main/ipc/handlers/types.ts` and import in renderer.
   Estimated effort: 20 minutes

4. **Medium Priority - Extract GlobalStatsCalculator**
   Refactor the 200-line `getGlobalStats` handler into a dedicated class with proper separation of concerns.
   Estimated effort: 1-2 hours

5. **Low Priority - Add Debug Logging to Catch Blocks**
   Replace empty `catch { }` with `catch (e) { logger.debug('Skipping file', e); }` or similar.
   Estimated effort: 15 minutes

6. **Low Priority - Extract Magic Numbers**
   Add `STATS_PROGRESS_BATCH_SIZE = 10` constant.
   Estimated effort: 5 minutes

7. **Low Priority - Flatten Codex Discovery**
   Use async generator or flatten the nested structure in `discoverCodexSessionFiles`.
   Estimated effort: 30 minutes

## Estimated Impact

**Risk Level:** Low to Medium
- Most changes are extraction refactors that don't change behavior
- Session discovery deduplication requires careful testing with both Claude and Codex sessions
- The file has good test coverage (338 lines of tests)

**Testing Considerations:**
- Unit tests exist for most handlers except `getGlobalStats` and `getAllNamedSessions`
- Integration tests should verify progressive update streaming
- Manual testing with both Claude Code and Codex sessions recommended for discovery changes
